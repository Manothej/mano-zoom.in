<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mano Zoom</title>
  <style>
    body,html {margin:0;padding:0;height:100%;display:flex;flex-direction:column;font-family:sans-serif;background:#111;color:#fff;}
    header {background:#222;display:flex;align-items:center;padding:10px;font-size:20px;font-weight:bold;}
    header img {height:28px;margin-right:10px;}
    #main {flex:1;display:flex;overflow:hidden;}
    #videos {flex:2;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:5px;background:#000;padding:5px;overflow:auto;}
    #chat {flex:1;display:flex;flex-direction:column;background:#1c1c1c;border-left:2px solid #333;}
    #messages {flex:1;overflow-y:auto;padding:5px;}
    #chat input, #chat select {padding:5px;margin:3px;border:none;border-radius:4px;}
    #controls {background:#222;padding:8px;text-align:center;}
    button {margin:3px;padding:6px 10px;border:none;border-radius:4px;font-weight:bold;cursor:pointer;}
    video {width:100%;height:100%;object-fit:cover;border-radius:8px;}
    .wrap {position:relative;}
    .watermark {position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.5);padding:3px 6px;font-size:12px;border-radius:4px;color:#fff;}
    #invite {font-size:13px;margin-top:4px;}
  </style>
</head>
<body>
  <header>
    <img src="https://img.icons8.com/ios-filled/50/ffffff/video-call.png" alt="logo"/>
    Mano Zoom
  </header>

  <div id="controls">
    <button onclick="createRoom()">Create Room</button>
    <input id="room" placeholder="Enter code"/>
    <button onclick="joinRoom()">Join Room</button>
    <button onclick="toggleMute()">Mute</button>
    <button onclick="toggleVideo()">Camera</button>
    <button onclick="shareScreen()">Share Screen</button>
    <button onclick="goFullscreen()">Fullscreen</button>
    <button onclick="leaveRoom()">Leave</button>
    <div id="invite"></div>
  </div>

  <div id="main">
    <div id="videos"></div>
    <div id="chat">
      <div id="messages"></div>
      <div>
        <select id="recipient"><option value="all">All</option></select>
        <input id="msgBox" placeholder="Type message..." onkeydown="if(event.key==='Enter')sendMessage()"/>
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let localStream,myPeer,roomCode,ws;
    let peers={},conns={};let muted=false,videoOff=false;

    async function init(){
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      addVideo("me",localStream,true);

      const hash = location.hash.replace("#","");
      if(hash){
        document.getElementById("room").value = hash;
        joinRoom(); // auto-join if link has #ROOMCODE
      }
    }

    function createRoom(){
      roomCode=Math.random().toString(36).substring(2,8).toUpperCase();
      const link=location.origin+location.pathname+"#"+roomCode;
      document.getElementById("invite").innerHTML=`Invite: <a href="${link}" target="_blank">${link}</a>`;
      document.getElementById("room").value=roomCode;
      joinRoom();
    }

    function joinRoom(){
      roomCode=document.getElementById("room").value.trim();
      if(!roomCode)return alert("Enter code");
      location.hash=roomCode;
      myPeer=new Peer(undefined,{debug:2});
      myPeer.on("open",id=>{
        ws=new WebSocket("wss://0.peerjs.com/peerjs?key=peerjs&id="+id+"&room="+roomCode);
        ws.onmessage=msg=>{
          let data=JSON.parse(msg.data);
          if(data.type==="peer"&&data.peer!==id){connectToUser(data.peer);}
        };
      });
      myPeer.on("call",call=>{
        call.answer(localStream);
        call.on("stream",s=>addVideo(call.peer,s));
      });
      myPeer.on("connection",conn=>{
        conns[conn.peer]=conn;
        addRecipient(conn.peer);
        conn.on("data",d=>showMsg(conn.peer,d.text,d.to));
      });
    }

    function connectToUser(id){
      const call=myPeer.call(id,localStream);
      call.on("stream",s=>addVideo(id,s));
      peers[id]=call;
      const conn=myPeer.connect(id);
      conn.on("open",()=>{conns[id]=conn;addRecipient(id);});
      conn.on("data",d=>showMsg(id,d.text,d.to));
    }

    function addVideo(id,stream,isLocal=false){
      if(document.getElementById("v"+id))return;
      const video=document.createElement("video");
      video.id="v"+id;video.srcObject=stream;video.autoplay=true;if(isLocal)video.muted=true;
      const wrap=document.createElement("div");wrap.className="wrap";wrap.appendChild(video);
      const mark=document.createElement("div");mark.className="watermark";mark.innerText="powered by manotej";
      wrap.appendChild(mark);
      document.getElementById("videos").appendChild(wrap);
    }

    function addRecipient(id){
      if(!document.querySelector(`#recipient option[value='${id}']`)){
        const opt=document.createElement("option");
        opt.value=id;opt.textContent=id;document.getElementById("recipient").appendChild(opt);
      }
    }

    function sendMessage(){
      const msg=document.getElementById("msgBox").value.trim();if(!msg)return;
      const to=document.getElementById("recipient").value;
      if(to==="all"){
        showMsg("me",msg,"all");
        for(let id in conns){conns[id].send({text:msg,to:"all"});}
      }else{
        showMsg("me",msg,to);
        if(conns[to])conns[to].send({text:msg,to});
      }
      document.getElementById("msgBox").value="";
    }

    function showMsg(sender,msg,to){
      const div=document.createElement("div");
      let tag=(to==="all")?"[All]":"[Private]";
      div.textContent=`${sender} ${tag}: ${msg}`;
      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop=document.getElementById("messages").scrollHeight;
    }

    function toggleMute(){muted=!muted;localStream.getAudioTracks()[0].enabled=!muted;}
    function toggleVideo(){videoOff=!videoOff;localStream.getVideoTracks()[0].enabled=!videoOff;}
    async function shareScreen(){
      const s=await navigator.mediaDevices.getDisplayMedia({video:true});
      const track=s.getVideoTracks()[0];
      for(let id in peers){
        const sender=peers[id].peerConnection.getSenders().find(x=>x.track.kind==="video");
        sender.replaceTrack(track);
      }
      track.onended=()=>{const cam=localStream.getVideoTracks()[0];
        for(let id in peers){
          const sender=peers[id].peerConnection.getSenders().find(x=>x.track.kind==="video");
          sender.replaceTrack(cam);
        }
      };
    }
    function goFullscreen(){document.documentElement.requestFullscreen();}
    function leaveRoom(){for(let id in peers){peers[id].close();}if(myPeer)myPeer.destroy();document.getElementById("videos").innerHTML="";}
    init();
  </script>
</body>
</html>
